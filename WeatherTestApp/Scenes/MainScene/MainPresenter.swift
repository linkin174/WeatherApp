//
//  MainPresenter.swift
//  WeatherTestApp
//
//  Created by Aleksandr Kretov on 06.12.2022.
//  Copyright (c) 2022 ___ORGANIZATIONNAME___. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

protocol MainPresentationLogic {
    func presentWeather(response: MainScene.LoadWeather.Response)
    func presentError(response: MainScene.HandleError.Response)
    func presentSearchResults(response: MainScene.SearchCities.Response)
}

final class MainPresenter: MainPresentationLogic {
    // MARK: - Public Properties

    weak var viewController: MainDisplayLogic?

    // MARK: - Presentation Logic

    func presentWeather(response: MainScene.LoadWeather.Response) {
        let cellsViewModels = response.weather.map { currentWeather in
            let icon = getWeatherIcon(from: currentWeather.weather.first?.icon)
            return WeatherCellViewModel(cityName: currentWeather.name ?? "--",
                                        weatherIcon: icon,
                                        temp: getFormattedTemp(currentWeather.main.temp),
                                        currentTime: getHoursFrom(currentWeather.timezone),
                                        cityId: currentWeather.internalId ?? 0)
        }

        let viewModel = MainScene.LoadWeather.ViewModel(weatherCellViewModels: cellsViewModels, placeCellViewModels: [])
        viewController?.displayCurrentWeather(viewModel: viewModel)
    }

    func presentSearchResults(response: MainScene.SearchCities.Response) {
        let cellsViewModels = response.filteredForecast.map { currentWeather in
            let icon = getWeatherIcon(from: currentWeather.weather.first?.icon)
            return WeatherCellViewModel(cityName: currentWeather.name ?? "--",
                                        weatherIcon: icon,
                                        temp: getFormattedTemp(currentWeather.main.temp),
                                        currentTime: getHoursFrom(currentWeather.timezone),
                                        cityId: currentWeather.internalId ?? 0)
        }

        let placesViewModels = response.places.map { PlaceCellViewModel(cityName: $0.name,
                                                                        stateName: $0.state,
                                                                        countryName: getCountryName(from: $0.country)) }

        let viewModel = MainScene.LoadWeather.ViewModel(weatherCellViewModels: cellsViewModels, placeCellViewModels: placesViewModels)
        viewController?.displaySearchResults(viewModel: viewModel)
    }

    func presentError(response: MainScene.HandleError.Response) {
        let messege = response.error.asAFError?.localizedDescription
        let viewModel = MainScene.HandleError.ViewModel(errorMessage: messege ?? "")
        viewController?.displayError(viewModel: viewModel)
    }

    // MARK: - Private methods

    private func getCountryName(from countryCode: String) -> String {
        let currentLocale = Locale.current
        return currentLocale.localizedString(forRegionCode: countryCode) ?? countryCode
    }

    private func getWeatherIcon(from code: String?) -> UIImage? {
        guard
            let codePrefix = code?.prefix(2),
            let image = UIImage(named: String(codePrefix))
        else { return nil }
        return image
    }

    private func getHoursFrom(_ secondsGMT: Int?) -> String {
        guard let secondsGMT else { return "12:00" }
        let date = Date()
        let timeZone = TimeZone(secondsFromGMT: secondsGMT)
        let formatter = DateFormatter()
        formatter.timeZone = timeZone
        formatter.dateFormat = "HH:mm"
        return formatter.string(from: date)
    }

    private func getFormattedTemp(_ temp: Double?) -> String {
        guard let temp else { return "--" }
        if round(temp) == 0 {
            // If temp is Zero ignore "-" sign and return 0
            return NSString(format: "0%@" as NSString, "\u{00B0}") as String
        } else {
            let roundedTemp = String(format: "%.f", temp)
            return NSString(format: "\(roundedTemp)%@" as NSString, "\u{00B0}") as String
        }
    }
}
